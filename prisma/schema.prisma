generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserType {
  CLIENT
  EMPLOYEE
  SYSTEM_ADMIN
}

enum EmployeeStatus {
  WORKING
  NOT_WORKING
}

enum IdentityType {
  PHONE
}

enum OtpChannel {
  SMS
}

enum OtpStatus {
  PENDING
  VERIFIED
  EXPIRED
  LOCKED
  CANCELED
}

enum RefreshStatus {
  ACTIVE
  REVOKED
  ROTATED
  EXPIRED
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  userType  UserType
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile              PersonProfile?
  client               Client?
  employee             Employee?
  systemAdminCredential SystemAdminCredential?

  identities    AuthIdentity[]
  roles         UserRole[]
  refreshTokens RefreshToken[]

  // Optional backlink for role assignment audit
  assignedRoles UserRole[] @relation("AssignedByUser")
}

model PersonProfile {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @unique @db.Uuid
  lastName   String
  firstName  String
  middleName String?
  iin        String   @unique @db.Char(12)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Client {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Employee {
  id        String         @id @default(uuid()) @db.Uuid
  userId    String         @unique @db.Uuid
  hireDate  DateTime
  fireDate  DateTime?
  status    EmployeeStatus @default(WORKING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Role {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users UserRole[]
}

model UserRole {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @db.Uuid
  roleId      String   @db.Uuid
  assignedAt  DateTime @default(now())
  assignedById String? @db.Uuid

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedByUser User? @relation("AssignedByUser", fields: [assignedById], references: [id], onDelete: SetNull)

  @@unique([userId, roleId])
  @@index([roleId])
}

model AuthIdentity {
  id            String       @id @default(uuid()) @db.Uuid
  userId        String       @db.Uuid
  identityType  IdentityType @default(PHONE)
  phoneE164     String       @unique @db.VarChar(20)
  failedAttempts Int         @default(0)
  lockedUntil   DateTime?
  lastOtpSentAt DateTime?
  isPrimary     Boolean      @default(true)
  isVerified    Boolean      @default(false)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenges OtpChallenge[]

  @@index([userId, lockedUntil])
}

model OtpChallenge {
  id             String     @id @default(uuid()) @db.Uuid
  identityId     String     @db.Uuid
  channel        OtpChannel @default(SMS)
  codeHash       String
  expiresAt      DateTime
  status         OtpStatus  @default(PENDING)
  verifyAttempts Int        @default(0)
  maxAttempts    Int        @default(5)
  requestIp      String?    @db.VarChar(45)
  userAgent      String?    @db.VarChar(512)
  createdAt      DateTime   @default(now())
  verifiedAt     DateTime?

  identity AuthIdentity @relation(fields: [identityId], references: [id], onDelete: Cascade)
  attempts OtpAttempt[]

  @@index([identityId, expiresAt, status])
}

model OtpAttempt {
  id          String   @id @default(uuid()) @db.Uuid
  challengeId String   @db.Uuid
  attemptedAt DateTime @default(now())
  ip          String?  @db.VarChar(45)
  isSuccess   Boolean
  reason      String?  @db.VarChar(64)

  challenge OtpChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@index([challengeId, attemptedAt])
}

model RefreshToken {
  id           String        @id @default(uuid()) @db.Uuid
  userId       String        @db.Uuid
  tokenHash    String        @unique
  status       RefreshStatus @default(ACTIVE)
  issuedAt     DateTime      @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?

  rotatedToId  String? @unique @db.Uuid
  replacedById String? @unique @db.Uuid

  ip        String? @db.VarChar(45)
  userAgent String? @db.VarChar(512)
  deviceId  String? @db.VarChar(128)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  rotatedTo   RefreshToken? @relation("RefreshRotatedTo", fields: [rotatedToId], references: [id], onDelete: SetNull)
  rotatedFrom RefreshToken? @relation("RefreshRotatedTo")

  replacedBy RefreshToken? @relation("RefreshReplacedBy", fields: [replacedById], references: [id], onDelete: SetNull)
  replaces   RefreshToken? @relation("RefreshReplacedBy")

  @@index([userId, expiresAt, status])
}

model SystemAdminCredential {
  id                String   @id @default(uuid()) @db.Uuid
  userId            String   @unique @db.Uuid
  passwordHash      String
  passwordUpdatedAt DateTime @default(now())
  lastLoginAt       DateTime?
  createdAt         DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AppSetting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  value     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------
// Project Catalog
// NOTE: Table name `projects` is reserved for the execution domain.

enum Locale {
  ru
  kk
  en
}

enum CatalogProjectStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CatalogMediaType {
  GALLERY_IMAGE
  FLOOR_PLAN
  FACADE
  VIDEO_THUMBNAIL
  VIDEO_FILE
}

enum CatalogBulletType {
  STRUCTURAL_CONCEPT
  WHO_FOR
  PRICE_INCLUDES
}

model ProjectsCatalog {
  id            String               @id @default(uuid()) @db.Uuid
  code          String               @unique
  status        CatalogProjectStatus
  featured      Boolean              @default(false)
  areaM2        Decimal              @db.Decimal(10, 2) @map("area_m2")
  floors        Int
  bedrooms      Int?
  priceAmount   BigInt               @map("price_amount")
  priceCurrency String               @db.Char(3) @default("KZT") @map("price_currency")
  styleId       String?              @db.Uuid @map("style_id")
  materialId    String?              @db.Uuid @map("material_id")
  createdAt     DateTime             @default(now()) @map("created_at")
  updatedAt     DateTime             @updatedAt @map("updated_at")

  style         ProjectsCatalogStyle?        @relation(fields: [styleId], references: [id], onDelete: SetNull)
  material      ProjectsCatalogMaterial?     @relation(fields: [materialId], references: [id], onDelete: SetNull)
  translations  ProjectsCatalogTranslation[]
  media         ProjectsCatalogMedia[]
  bullets       ProjectsCatalogBullet[]
  materials     ProjectsCatalogProjectConstructionMaterial[]

  @@index([status])
  @@index([featured])
  @@index([floors])
  @@index([areaM2])
  @@index([priceAmount])
  @@index([styleId])
  @@index([materialId])
  @@map("ProjectsCatalog")
}

model ProjectsCatalogTranslation {
  id                         String   @id @default(uuid()) @db.Uuid
  projectId                  String   @db.Uuid @map("project_id")
  locale                     Locale
  name                       String
  characteristics            String
  description                String
  implementationText         String   @map("implementation_text")
  timelineDesignPhaseValue   String   @map("timeline_design_phase_value")
  timelineConstructionValue  String   @map("timeline_construction_value")
  timelineFullCycleValue     String   @map("timeline_full_cycle_value")
  videoTitle                 String?  @map("video_title")
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  project ProjectsCatalog @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, locale])
  @@index([locale])
  @@map("ProjectsCatalogTranslation")
}

model ProjectsCatalogStyle {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  translations ProjectsCatalogStyleTranslation[]
  projects     ProjectsCatalog[]

  @@map("ProjectsCatalogStyle")
}

model ProjectsCatalogStyleTranslation {
  id        String   @id @default(uuid()) @db.Uuid
  styleId   String   @db.Uuid @map("style_id")
  locale    Locale
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  style ProjectsCatalogStyle @relation(fields: [styleId], references: [id], onDelete: Cascade)

  @@unique([styleId, locale])
  @@index([locale])
  @@map("ProjectsCatalogStyleTranslation")
}

model ProjectsCatalogMaterial {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  translations ProjectsCatalogMaterialTranslation[]
  projects     ProjectsCatalog[]

  @@map("ProjectsCatalogMaterial")
}

model ProjectsCatalogMaterialTranslation {
  id         String   @id @default(uuid()) @db.Uuid
  materialId String   @db.Uuid @map("material_id")
  locale     Locale
  name       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  material ProjectsCatalogMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, locale])
  @@index([locale])
  @@map("ProjectsCatalogMaterialTranslation")
}

model ProjectsCatalogConstructionMaterial {
  id        String   @id @default(uuid()) @db.Uuid
  code      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  translations ProjectsCatalogConstructionMaterialTranslation[]
  projects     ProjectsCatalogProjectConstructionMaterial[]

  @@map("ProjectsCatalogConstructionMaterial")
}

model ProjectsCatalogConstructionMaterialTranslation {
  id         String   @id @default(uuid()) @db.Uuid
  materialId String   @db.Uuid @map("material_id")
  locale     Locale
  name       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  material ProjectsCatalogConstructionMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([materialId, locale])
  @@index([locale])
  @@map("ProjectsCatalogConstructionMaterialTranslation")
}

model ProjectsCatalogProjectConstructionMaterial {
  id        String @id @default(uuid()) @db.Uuid
  projectId String @db.Uuid @map("project_id")
  materialId String @db.Uuid @map("material_id")
  sortOrder Int @default(0) @map("sort_order")

  project  ProjectsCatalog                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  material ProjectsCatalogConstructionMaterial  @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([projectId, materialId])
  @@index([projectId, sortOrder])
  @@index([materialId])
  @@map("ProjectsCatalogProjectConstructionMaterial")
}

model ProjectsCatalogMedia {
  id              String          @id @default(uuid()) @db.Uuid
  projectId        String          @db.Uuid @map("project_id")
  type            CatalogMediaType
  url             String
  sortOrder       Int             @default(0) @map("sort_order")
  title           String?
  durationSeconds Int?            @map("duration_seconds")
  isCover         Boolean         @default(false) @map("is_cover")
  createdAt       DateTime        @default(now()) @map("created_at")

  project ProjectsCatalog @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, type])
  @@index([type])
  @@index([projectId, type, sortOrder])
  @@map("ProjectsCatalogMedia")
}

model ProjectsCatalogBullet {
  id        String            @id @default(uuid()) @db.Uuid
  projectId String            @db.Uuid @map("project_id")
  type      CatalogBulletType
  sortOrder Int               @default(0) @map("sort_order")
  createdAt DateTime          @default(now()) @map("created_at")

  project      ProjectsCatalog                    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  translations ProjectsCatalogBulletTranslation[]

  @@index([projectId, type])
  @@index([projectId, type, sortOrder])
  @@map("ProjectsCatalogBullet")
}

model ProjectsCatalogBulletTranslation {
  id       String @id @default(uuid()) @db.Uuid
  bulletId String @db.Uuid @map("bullet_id")
  locale   Locale
  text     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  bullet ProjectsCatalogBullet @relation(fields: [bulletId], references: [id], onDelete: Cascade)

  @@unique([bulletId, locale])
  @@index([locale])
  @@map("ProjectsCatalogBulletTranslation")
}

// NOTE: "Only one SYSTEM_ADMIN" is not reliably enforceable purely with Prisma schema.
// Seed ensures at most one SYSTEM_ADMIN user is created; application code should enforce this rule.
